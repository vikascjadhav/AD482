"""
Common tasks for start/finish/grade scripts
"""

from . import get_oc_client
from .client import OcException


def check_ocp_api(item):
    endpoint: str = item["endpoint"]

    oc = get_oc_client(endpoint)

    if oc.is_api_up():
        item["failed"] = False
    else:
        item["failed"] = True
        item["msgs"] = [
            {"text": f"API could not be reached: {endpoint}"}
        ]


def check_ocp_credentials(item):
    username: str = item["username"]
    password: str = item["password"]
    endpoint: str = item["endpoint"]

    oc = get_oc_client(endpoint)

    try:
        oc.login(username, password)
        item["failed"] = False
    except OcException as e:
        item["failed"] = True
        item["msgs"] = e.get_messages_as_dict()


def create_projects(item):
    username: str = item['username']
    password: str = item['password']
    endpoint: str = item['endpoint']

    oc = get_oc_client(endpoint)

    try:
        oc.login(username, password)
        item['msgs'] = []
        for project in item['projects']:
            oc.new_project(project)
            item['msgs'].append({"text": f"Project created: '{project}'"})
        item['failed'] = False
    except OcException as e:
        item['failed'] = True
        item['msgs'] = e.get_messages_as_dict()


def delete_projects(item):
    username: str = item['username']
    password: str = item['password']
    endpoint: str = item['endpoint']

    oc = get_oc_client(endpoint)

    try:
        oc.login(username, password)
        item['msgs'] = []
        for project in item['projects']:
            oc.delete_project(project)
            item['msgs'].append({"text": f"Project deleted: '{project}'"})
        item['failed'] = False
    except OcException as e:
        item['failed'] = True
        item['msgs'] = e.get_messages_as_dict()
